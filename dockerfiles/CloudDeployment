FROM debian:jessie
MAINTAINER Jeff Bozek, jbozek@anypresence.com

### Add JAVA ###

RUN echo "deb http://ppa.launchpad.net/webupd8team/java/ubuntu trusty main" | tee /etc/apt/sources.list.d/webupd8team-java.list && \
    echo "deb-src http://ppa.launchpad.net/webupd8team/java/ubuntu trusty main" | tee -a /etc/apt/sources.list.d/webupd8team-java.list && \
    apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys EEA14886 && \
    apt-get update && \
    echo oracle-java8-installer shared/accepted-oracle-license-v1-1 select true | /usr/bin/debconf-set-selections && \
    apt-get install oracle-java8-installer -y && \
    apt-get clean

ENV JAVA_HOME /usr/lib/jvm/java-8-oracle

ADD build/gateway-linux-amd64 /gateway/gateway
ADD public_keys/production/production_license /gateway/license

EXPOSE 5000 5555 5556
WORKDIR /gateway

ENV DB_DRIVER sqlite3
ENV ADMIN_SESSION_AUTH_KEY please-change-me
ENV ADMIN_PATH /admin/
ENV PROXY_HOST 0.0.0.0
ENV ADMIN_HOST 0.0.0.0
ENV PROXY_DOMAIN localhost
ENV ENABLE_BROKER true
ENV BROKER_HOST localhost
ENV BROKER_PUB_PORT 5555
ENV BROKER_SUB_PORT 5556
ENV SCRIPT_ENABLED false
ENV ADMIN_SESSION_COOKIE_DOMAIN 0.0.0.0

# Database format: "dbname=my_db user=user sslmode=disable host=my_host password=my_password"
ENTRYPOINT ./gateway -server -db-migrate -proxy-cache-apis -proxy-host=$PROXY_HOST -admin-host=$ADMIN_HOST -proxy-domain=$PROXY_DOMAIN \
  -db-driver=$DB_DRIVER -admin-session-auth-key=$ADMIN_SESSION_AUTH_KEY -admin-path-prefix=$ADMIN_PATH -admin-session-cookie-domain=$ADMIN_SESSION_COOKIE_DOMAIN \
  -enable-broker=$ENABLE_BROKER -broker=$BROKER_HOST -broker-pub-port=$BROKER_PUB_PORT -broker-sub-port=$BROKER_SUB_PORT \
  -remote-endpoint-script-enabled=$SCRIPT_ENABLED \
  -db-conn-string="$DB_CONN"
